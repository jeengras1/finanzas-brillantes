name: 1. Corte Suprema - Validador Constitucional

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  pull-requests: write

jobs:
  validacion-con-ia:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Checkout del código del proyecto
        uses: actions/checkout@v4

      - name: 2. Realizar Validación con ChatGPT (El Abogado)
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo, number } = context.issue;
            const fs = require('fs');

            // --- 1. Leer los Documentos ---
            const leyDeMision = fs.readFileSync('constitucion/LEY-02-MISION.md', 'utf8');
            const pr = await github.rest.pulls.get({ owner, repo, pull_number: number });
            const propuesta = pr.data.body || "El cuerpo de la propuesta está vacío.";

            // --- 2. Preparar el Caso para la IA ---
            const prompt = `
              Eres el Abogado Constitucional de un proyecto. Tu única misión es validar si una nueva propuesta se alinea con la Ley de Misión.
              **LEY DE MISIÓN (La Regla):**\n---\n${leyDeMision}\n---\n
              **NUEVA PROPUESTA A JUZGAR:**\n---\n${propuesta}\n---\n
              **TU VEREDICTO:**
              Responde con un análisis corto y claro. Empieza tu respuesta con "VEREDICTO:" y luego indica si la propuesta se ALINEA o DESALINEA con la ley, y por qué.
            `;

            // --- 3. Llamar a la API de ChatGPT ---
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${{ secrets.OPENAI_API_KEY }}`
              },
              body: JSON.stringify({
                model: 'gpt-4o',
                messages: [{ role: 'user', content: prompt }]
              })
            });
            const data = await response.json();
            if (!data.choices || data.choices.length === 0) {
              throw new Error("La respuesta de la API de OpenAI no contiene 'choices'. Respuesta completa: " + JSON.stringify(data));
            }
            const veredictoIA = data.choices[0].message.content;

            // --- 4. Publicar el Veredicto de la IA ---
            const comentarioFinal = `
              🏛️ **Veredicto de la Corte Suprema (v3)** 🏛️\n\n
              ¡Hola Director! Se ha consultado a Nexus (ChatGPT) para una validación constitucional.\n\n
              **Propuesta Analizada:**\n> ${propuesta}\n\n
              **Análisis del Abogado Constitucional:**\n> ${veredictoIA}
            `;
            await github.rest.issues.createComment({ owner, repo, issue_number: number, body: comentarioFinal });
